<?xml version="1.0" encoding="utf-8" ?>

<odoo>
    <!-- List view for tasks -->
    <record model="ir.ui.view" id="project_task_list_view">
        <field name="name">scientific.task.list</field>
        <field name="model">scientific.task</field>
        <field name="type">tree</field>
        <field name="arch" type="xml">
            <tree decoration-danger="is_overdue" decoration-success="status=='done'" decoration-muted="status=='cancelled'">
                <field name="priority" widget="priority"/>
                <field name="name"/>
                <field name="project_id"/>
                <field name="assigned_count"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="days_remaining" optional="show"/>
                <field name="status" decoration-success="status=='done'"
                       decoration-info="status=='in_progress'"
                       decoration-warning="status=='todo'"
                       decoration-muted="status=='cancelled'"/>
                <field name="progress" optional="show"/>
                <field name="is_overdue" invisible="1"/>
            </tree>
        </field>
    </record>

    <!-- Form view for creating and editing tasks -->
    <record model="ir.ui.view" id="project_task_form_view">
        <field name="name">scientific.task.form</field>
        <field name="model">scientific.task</field>
        <field name="type">form</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_todo" string="To Do" type="object" states="in_progress,done,cancelled"/>
                    <button name="action_in_progress" string="Start Task" type="object" class="oe_highlight" states="todo"/>
                    <button name="action_done" string="Mark as Done" type="object" class="oe_highlight" states="in_progress"/>
                    <button name="action_cancelled" string="Cancel" type="object" states="todo,in_progress"/>
                    <field name="status" widget="statusbar" statusbar_visible="todo,in_progress,done"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" icon="fa-users">
                            <field string="Assigned" name="assigned_count" widget="statinfo"/>
                        </button>
                    </div>

                    <widget name="web_ribbon" title="Overdue" bg_color="bg-danger" attrs="{'invisible': [('is_overdue', '=', False)]}"/>

                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" placeholder="Task Name..."/>
                        </h1>
                    </div>

                    <group>
                        <group>
                            <field name="project_id"/>
                            <field name="experiment_id"/>
                            <field name="priority" widget="priority"/>
                        </group>
                        <group>
                            <field name="start_date"/>
                            <field name="end_date"/>
                            <field name="duration_days" attrs="{'invisible': [('duration_days', '=', 0)]}"/>
                            <field name="days_remaining" attrs="{'invisible': [('days_remaining', '=', 0)]}"/>
                            <field name="progress"/>
                        </group>
                    </group>

                    <group>
                        <field name="description" placeholder="Task description..."/>
                    </group>

                    <notebook>
                        <page string="Team" name="team">
                            <field name="assigned_to_ids" widget="many2many_tags"/>
                        </page>
                        <page string="Documents" name="documents">
                            <field name="document_id"/>
                        </page>
                        <page string="Notes" name="notes">
                            <field name="notes" placeholder="Additional notes..."/>
                        </page>
                    </notebook>

                    <field name="is_overdue" invisible="1"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Kanban view for tasks -->
    <record model="ir.ui.view" id="project_task_kanban_view">
        <field name="name">scientific.task.kanban</field>
        <field name="model">scientific.task</field>
        <field name="type">kanban</field>
        <field name="arch" type="xml">
            <kanban default_group_by="status" class="o_kanban_small_column">
                <field name="id"/>
                <field name="name"/>
                <field name="priority"/>
                <field name="status"/>
                <field name="is_overdue"/>
                <field name="days_remaining"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click #{record.is_overdue.raw_value ? 'oe_kanban_color_2' : ''}">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="priority" widget="priority"/>
                                        <field name="name"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div t-if="record.project_id.value">
                                    <i class="fa fa-folder"/> <field name="project_id"/>
                                </div>
                                <div t-if="record.assigned_to_ids.raw_value.length > 0">
                                    <field name="assigned_to_ids" widget="many2many_avatar_user"/>
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="end_date"/>
                                </div>
                                <div class="oe_kanban_bottom_right" t-if="record.is_overdue.raw_value">
                                    <span class="badge badge-danger">Overdue</span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Calendar view -->
    <record model="ir.ui.view" id="project_task_calendar_view">
        <field name="name">scientific.task.calendar</field>
        <field name="model">scientific.task</field>
        <field name="type">calendar</field>
        <field name="arch" type="xml">
            <calendar string="Tasks" date_start="start_date" date_stop="end_date" mode="month" color="priority">
                <field name="name"/>
                <field name="status"/>
                <field name="project_id"/>
            </calendar>
        </field>
    </record>

    <!-- Gantt View for Tasks -->
    <record id="view_task_gantt" model="ir.ui.view">
        <field name="name">scientific.task.gantt</field>
        <field name="model">scientific.task</field>
        <field name="arch" type="xml">
            <gantt string="Tasks Gantt"
                   date_start="start_date"
                   date_stop="end_date"
                   default_group_by="project_id"
                   color="priority">
                <field name="name"/>
                <field name="status"/>
                <field name="progress"/>
            </gantt>
        </field>
    </record>

    <!-- Search View for Tasks -->
    <record id="view_task_search" model="ir.ui.view">
        <field name="name">scientific.task.search</field>
        <field name="model">scientific.task</field>
        <field name="arch" type="xml">
            <search string="Search Tasks">
                <field name="name"/>
                <field name="project_id"/>
                <field name="assigned_to_ids"/>
                <filter string="My Tasks" name="my_tasks"
                        domain="[('assigned_to_ids.user_id', '=', uid)]"/>
                <filter string="Overdue" name="overdue" domain="[('is_overdue', '=', True)]"/>
                <separator/>
                <filter string="To Do" name="todo" domain="[('status', '=', 'todo')]"/>
                <filter string="In Progress" name="in_progress" domain="[('status', '=', 'in_progress')]"/>
                <filter string="Done" name="done" domain="[('status', '=', 'done')]"/>
                <separator/>
                <filter string="High Priority" name="high_priority" domain="[('priority', 'in', ['2', '3'])]"/>
                <group expand="0" string="Group By">
                    <filter string="Status" name="group_status" context="{'group_by': 'status'}"/>
                    <filter string="Priority" name="group_priority" context="{'group_by': 'priority'}"/>
                    <filter string="Project" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="Due Date" name="group_due" context="{'group_by': 'end_date'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action for tasks -->
    <record id="project_task_action" model="ir.actions.act_window">
        <field name="name">Tasks</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">scientific.task</field>
        <field name="view_mode">tree,kanban,form,gantt,calendar</field>
        <field name="search_view_id" ref="view_task_search"/>
        <field name="context">{'search_default_my_tasks': 1, 'search_default_in_progress': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new task
            </p>
        </field>
    </record>

    <!-- Menu item for tasks -->
    <menuitem id="project_task_menu"
              name="Tasks"
              parent="scientific_projects_root"
              action="project_task_action"
              sequence="11"/>

</odoo>
